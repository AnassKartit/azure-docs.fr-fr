---
title: Stocker les résultats de l’analyse Évaluation des vulnérabilités dans un compte de stockage accessible derrière des pare-feu et réseaux virtuels
description: Fournit des instructions sur le stockage des analyses Évaluation des vulnérabilités dans un compte de stockage accessible via un pare-feu ou un réseau virtuel
services: sql-database
ms.service: sql-db-mi
ms.subservice: security
ms.topic: how-to
author: davidtrigano
ms.author: datrigan
ms.reviewer: vanto
ms.date: 12/01/2020
ms.openlocfilehash: c2a8d9420485b10716619388f58afb01af5ea623
ms.sourcegitcommit: 80d311abffb2d9a457333bcca898dfae830ea1b4
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 05/26/2021
ms.locfileid: "110468836"
---
# <a name="store-vulnerability-assessment-scan-results-in-a-storage-account-accessible-behind-firewalls-and-vnets"></a>Stocker les résultats de l’analyse Évaluation des vulnérabilités dans un compte de stockage accessible derrière des pare-feu et réseaux virtuels
[!INCLUDE[appliesto-sqldb-sqlmi-asa](../includes/appliesto-sqldb-sqlmi-asa.md)]

Si vous limitez l’accès à votre compte de stockage dans Azure pour certains réseaux virtuels ou services, vous devez activer la configuration appropriée pour que l’analyse Évaluation des vulnérabilités des instances SQL Database ou Managed Instance ait accès à ce compte de stockage.

## <a name="prerequisites"></a>Prérequis

Le service d’évaluation des vulnérabilités SQL a besoin d’une autorisation sur le compte de stockage pour enregistrer les résultats d’analyse et de ligne de base.  Il existe trois modules : 
- **Utiliser la clé de compte de stockage** : Azure crée la clé SAS et l’enregistre (bien que nous n’enregistrions pas la clé de compte)
- **Utiliser la clé SAS de stockage** : la clé SAS doit disposer des autorisations : Écriture | Liste | Lecture | Suppression
- **Utiliser l’identité managée SQL Server** : SQL Server doit disposer d’une identité managée. Le compte de stockage doit disposer d’une attribution de rôle StorageBlobContributor pour l’identité managée SQL. Quand vous appliquez les paramètres, les champs de l’évaluation des vulnérabilités storageContainerSasKey et storageAccountAccessKey doivent être vides. Quand le stockage se trouve derrière un pare-feu ou un réseau virtuel, l’identité managée SQL est requise. 

Quand vous utilisez le portail Azure pour enregistrer les paramètres SQL de l’évaluation des vulnérabilités, Azure vérifie si vous avez l’autorisation de procéder à une nouvelle attribution de rôle StorageBlobContributor pour l’identité managée sur le stockage. Si des autorisations sont attribuées, Azure utilise l’identité managée SQL Server. Dans le cas contraire, Azure utilise la méthode de clé. 

## <a name="enable-azure-sql-database-va-scanning-access-to-the-storage-account"></a>Activer l’accès de l’analyse Évaluation des vulnérabilités d’Azure SQL Database au compte de stockage

Si vous avez configuré votre compte de stockage Évaluation des vulnérabilités de façon à ce qu’il soit accessible uniquement par certains réseaux ou services, vous devez vous assurer que les analyses Évaluation des vulnérabilités de votre Azure SQL Database sont en mesure de stocker les résultats sur le compte de stockage. Vous pouvez utiliser le compte de stockage existant ou en créer un pour stocker les résultats de l’analyse Évaluation des vulnérabilités pour toutes les bases de données de votre [serveur SQL logique](logical-servers.md).

> [!NOTE]
> Le service d’évaluation des vulnérabilités ne peut pas accéder aux comptes de stockage protégés par des pare-feu ou réseaux virtuels s’ils requièrent des clés d’accès de stockage.

Accédez à votre **groupe de ressources** qui contient le compte de stockage, puis au volet **Compte de stockage**. Sous **Paramètres**, sélectionnez **Pare-feu et réseaux virtuels**.

Vérifiez que l’option **Autoriser les services Microsoft approuvés à accéder à ce compte de stockage** est cochée.

:::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-allow-microsoft-services.png" alt-text="La capture d’écran montre la boîte de dialogue Pare-feux et réseaux virtuels, avec l’option Autoriser les services Microsoft approuvés à accéder à ce compte de stockage sélectionnée.":::

Pour savoir quel est le compte de stockage utilisé, accédez au volet **SQL Server** dans le [portail Azure](https://portal.azure.com) et, sous **Sécurité**, sélectionnez **Security Center**.

:::image type="content" source="../database/media/azure-defender-for-sql/va-storage.png" alt-text="configurer l’évaluation des vulnérabilités":::

> [!NOTE]
> Vous pouvez configurer des alertes par e-mail pour notifier les utilisateurs de votre organisation afin qu’ils affichent les rapports d’analyse ou y accèdent. Pour ce faire, assurez-vous que vous disposez des autorisations du gestionnaire de sécurité SQL et du lecteur des données de l’objet blob du stockage.

## <a name="store-va-scan-results-for-azure-sql-managed-instance-in-a-storage-account-that-can-be-accessed-behind-a-firewall-or-vnet"></a>Stocker les résultats de l’analyse Évaluation des vulnérabilités pour Azure SQL Managed Instance dans un compte de stockage accessible derrière un pare-feu ou un réseau virtuel

Étant donné que Managed Instance n’est pas un service Microsoft approuvé et qu’il possède un réseau virtuel différent de celui du compte de stockage, l’exécution d’une analyse Évaluation des vulnérabilités génère une erreur.

Pour prendre en charge les analyses Évaluation des vulnérabilités sur les Managed Instances, suivez les étapes ci-dessous :

1. Dans le volet **Instance gérée SQL**, sous le titre **Vue d’ensemble**, cliquez sur le lien **Réseau virtuel/sous-réseau**. Vous accédez ainsi au volet **Réseau virtuel**.

   :::image type="content" source="../managed-instance/media/public-endpoint-configure/mi-overview.png" alt-text="mi-vue-d-ensemble2":::

1. Sous **Paramètres**, sélectionnez **Sous-réseaux**. Cliquez sur **Sous-réseau** dans le nouveau volet pour ajouter un sous-réseau, puis déléguez-le à *Microsoft.Sql\managedInstance*. Pour plus d’informations, consultez [Gérer les sous-réseaux](../../virtual-network/virtual-network-manage-subnet.md).

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-subnets.png" alt-text="La capture d’écran montre un sous-réseau qui a été délégué à Microsoft.sql\managedInstance.":::

1. Dans le volet **Réseau virtuel**, sous **Paramètres**, sélectionnez **Points de terminaison de service**. Cliquez sur **Ajouter** dans le nouveau volet, puis ajoutez le service *Microsoft.Storage* en tant que nouveau point de terminaison de service. Assurez-vous que le sous-réseau *ManagedInstance* est sélectionné. Cliquez sur **Add**.

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/mi-service-endpoint.png" alt-text="La capture d’écran montre la fenêtre Ajouter des points de terminaison de service, dans laquelle vous ajoutez le service Microsoft.Storage en tant que point de terminaison.":::

1. Accédez au **compte de stockage** que vous avez sélectionné pour stocker vos analyses Évaluation des vulnérabilités. Sous **Paramètres**, sélectionnez **Pare-feu et réseaux virtuels**. Cliquez sur **Ajouter un réseau virtuel existant**. Sélectionnez le réseau virtuel et le sous-réseau de votre instance gérée, puis cliquez sur **Ajouter**.

   :::image type="content" source="media/sql-database-vulnerability-assessment-storage/storage-firewall.png" alt-text="La capture d’écran montre le volet Pare-feux et réseaux virtuels, qui contient le lien Ajouter un réseau virtuel existant.":::

Vous devez maintenant être en mesure de stocker vos analyses Évaluation des vulnérabilités pour les Managed Instances dans votre compte de stockage.

## <a name="troubleshoot-vulnerability-assessment-scan-related-issues"></a>Résoudre les problèmes liés à l’analyse Évaluation des vulnérabilités 

Résolvez les problèmes courants liés aux analyses Évaluation des vulnérabilités.

### <a name="failure-to-save-vulnerability-assessment-settings"></a>Échec de l’enregistrement des paramètres de l’évaluation des vulnérabilités

Il est possible que vous ne puissiez pas enregistrer les modifications apportées aux paramètres d’évaluation des vulnérabilités si votre compte de stockage ne répond pas à certains prérequis ou si vous ne disposez pas d’autorisations suffisantes.

#### <a name="storage-account-requirements"></a>Exigences en matière de compte de stockage

Le compte de stockage dans lequel les résultats de l’analyse Évaluation des vulnérabilités sont enregistrés doit respecter les exigences suivantes :

- **Type** : StorageV2 (universel v2) ou Storage (universel v1)
- **Performances** : Standard (uniquement)
- **Région** : le stockage doit se trouver dans la même région que l’instance Azure SQL Server.

Si l’une de ces conditions n’est pas remplie, l’enregistrement des modifications apportées aux paramètres d’évaluation des vulnérabilités échoue.

#### <a name="permissions"></a>Autorisations 

Les autorisations suivantes sont requises pour enregistrer les modifications apportées aux paramètres d’évaluation des vulnérabilités :

- Gestionnaire de sécurité SQL
- Lecteur des données blob du stockage

Pour définir une nouvelle attribution de rôle, le propriétaire ou l’administrateur de l’utilisateur doit avoir accès au compte de stockage et aux autorisations suivantes :

- Propriétaire des données Blob du stockage

### <a name="storage-account-isnt-visible-for-selection-in-vulnerability-assessment-settings"></a>Le compte de stockage n’est pas visible et ne peut donc pas être sélectionné dans les paramètres de l’évaluation des vulnérabilités

Il est possible que le compte de stockage ne s’affiche pas dans le sélecteur de compte de stockage pour plusieurs raisons :

- Le compte de stockage que vous recherchez ne fait pas partie de l’abonnement sélectionné.
- Le compte de stockage que vous recherchez ne se trouve pas dans la même région que l’instance Azure SQL Server.
- Vous ne disposez pas des autorisations Microsoft.Storage/storageAccounts/read pour le compte de stockage.

### <a name="failure-to-open-an-email-link-for-scan-results-or-cant-view-scan-results"></a>Impossible d’ouvrir le lien de l’e-mail d’accès aux résultats de l’analyse ou impossible d’afficher les résultats

Il est possible que vous ne puissiez pas ouvrir un lien dans un e-mail de notification concernant les résultats de l’analyse ni afficher les résultats de l’analyse si vous n’avez pas les autorisations requises ou si vous utilisez un navigateur qui ne prend pas en charge l’ouverture ni l’affichage des résultats d’analyse.

#### <a name="permissions"></a>Autorisations

Les autorisations suivantes sont requises pour ouvrir des liens dans des notifications par e-mail concernant les résultats de l’analyse ou pour afficher les résultats de l’analyse :

- Gestionnaire de sécurité SQL
- Lecteur des données blob du stockage

#### <a name="browser-requirements"></a>Configuration requise des navigateurs

Le navigateur Firefox ne prend pas en charge l’ouverture ni l’affichage des résultats d’analyse. Nous vous recommandons d’utiliser Chrome ou Microsoft Edge pour afficher les résultats de l’analyse Évaluation des vulnérabilités.

## <a name="next-steps"></a>Étapes suivantes

- [Évaluation des vulnérabilités](sql-vulnerability-assessment.md)
- [Création d’un compte de stockage Azure](../../storage/common/storage-account-create.md)
- [Azure Defender pour SQL](azure-defender-for-sql.md)
