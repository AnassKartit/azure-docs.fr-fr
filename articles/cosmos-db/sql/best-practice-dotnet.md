---
title: Meilleures pratiques Azure Cosmos DB pour .NET SDK v3
description: Découvrez les meilleures pratiques pour l’utilisation du kit de développement logiciel (SDK) .net v3 Azure Cosmos DB
author: StefArroyo
ms.service: cosmos-db
ms.subservice: cosmosdb-sql
ms.topic: how-to
ms.date: 08/26/2021
ms.author: esarroyo
ms.openlocfilehash: b07162b95419a73be4bdecc5ff3160ded1c2a0e5
ms.sourcegitcommit: 40866facf800a09574f97cc486b5f64fced67eb2
ms.translationtype: HT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/30/2021
ms.locfileid: "123219618"
---
# <a name="best-practices-for-azure-cosmos-db-net-sdk"></a>Meilleures pratiques pour Azure Cosmos DB .NET SDK v3
[!INCLUDE[appliesto-sql-api](../includes/appliesto-sql-api.md)]

Cet article décrit les meilleures pratiques pour l’utilisation du kit de développement logiciel (SDK) .NET Azure Cosmos DB. Les pratiques suivantes vous aideront à améliorer la latence, la disponibilité et améliorer les performances globales. 

Regardez la vidéo ci-dessous pour en savoir plus sur l’utilisation du kit de développement logiciel (SDK) .NET à partir d’un ingénieur Cosmos DB !


> [!VIDEO https://www.youtube.com/embed/McZIQhZpvew?start=118]
>

## <a name="checklist"></a>Check-list
|Activée  | Rubrique  |Détails/Liens  |
|---------|---------|---------|
|<input type="checkbox"/> |    Version du SDK    |   Utilisez toujours la [dernière version](sql-api-sdk-dotnet-standard.md) du kit de développement logiciel (SDK) Cosmos DB disponible pour des performances optimales.     |
| <input type="checkbox"/>   |    Client Singleton     |       Utilisez une [seule instance](/dotnet/api/microsoft.azure.cosmos.cosmosclient?view=azure-dotnet&preserve-view=true) de `CosmosClient` pour la durée de vie de votre application pour de [meilleures performances](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage).     |
| <input type="checkbox"/>  |     Régions     |   Exécutez autant que possible votre application dans la même [région Azure](../distribute-data-globally.md) que celle dans laquelle se trouve votre compte Azure Cosmos DB. Activez les régions 2-4 et répliquez vos comptes dans plusieurs régions pour une [disponibilité optimale](../distribute-data-globally.md). Pour les charges de travail de production, activez le [basculement automatique](../how-to-manage-database-account.md#configure-multiple-write-regions). En l’absence de cette configuration, le compte subira une perte de disponibilité en écriture pendant toute la durée de la panne de la région d’écriture, car le basculement manuel échouera en raison d’un manque de connectivité de la région. Pour savoir comment ajouter plusieurs régions à l’aide du kit de développement logiciel (SDK) .NET, visitez [ici](tutorial-global-distribution-sql-api.md)   |
| <input type="checkbox"/>   |   Disponibilité et basculements     |  Définissez [ApplicationPreferredRegions](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationpreferredregions?view=azure-dotnet&preserve-view=true) ou [ApplicationRegion](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.applicationregion?view=azure-dotnet&preserve-view=true) dans le kit de développement logiciel (SDK) v3 et le [PreferredLocations](/dotnet/api/microsoft.azure.documents.client.connectionpolicy.preferredlocations?view=azure-dotnet&preserve-view=true) dans le kit de développement logiciel (SDK) v2 à l’aide de la  [liste des régions préférées](./tutorial-global-distribution-sql-api.md?tabs=dotnetv3%2capi-async#preferred-locations). Pendant les basculements, les opérations d’écriture sont envoyées à la région d’écriture en cours et toutes les lectures sont envoyées à la première région de la liste de régions de votre choix. Pour plus d’informations sur le mécanisme de basculement régional, consultez le [Guide de résolution des problèmes de disponibilité](troubleshoot-sdk-availability.md). |
|  <input type="checkbox"/> |    UC     |  Vous pouvez rencontrer des problèmes de connectivité/disponibilité en raison d’un manque de ressources sur votre ordinateur client. Surveillez l’utilisation du processeur sur les nœuds qui exécutent le client Azure Cosmos DB et augmentez/arrêtez si l’utilisation est très élevée.      |
| <input type="checkbox"/>   |    Hosting      |   Utilisez le traitement de [l’hôte 64 bits Windows](performance-tips.md#hosting) pour obtenir des performances optimales, dans la mesure du possible.       |
| <input type="checkbox"/> |    Modes de connectivité    |    Utilisez le [Mode direct](sql-sdk-connection-modes.md) pour obtenir des performances optimales.  Pour obtenir des instructions sur la procédure à suivre, consultez la [documentation du kit de développement logiciel (SDK) v3](performance-tips-dotnet-sdk-v3-sql.md#networking) ou la [documentation du kit de développement logiciel (SDK) v2](performance-tips.md#networking).|
|<input type="checkbox"/>  |    Mise en réseau   | Si vous utilisez une machine virtuelle pour exécuter votre application, activez la [Mise en réseau accélérée](../../virtual-network/create-vm-accelerated-networking-powershell.md) sur votre machine virtuelle pour faciliter les goulots d’étranglement dus à un trafic élevé et réduire la latence ou l’instabilité du processeur. Vous pouvez également envisager d’utiliser une Machine virtuelle de fin supérieure où l’utilisation maximale de l’UC est inférieure à 70%.    |
|<input type="checkbox"/> |  Épuisement des ports éphémères      | Pour les connexions éparses ou sporadiques, nous définissons [`IdleConnectionTimeout`](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.idletcpconnectiontimeout?view=azure-dotnet&preserve-view=true) et [`PortReuseMode`](/dotnet/api/microsoft.azure.cosmos.cosmosclientoptions.portreusemode?view=azure-dotnet&preserve-view=true) sur `PrivatePortPool` . La `IdleConnectionTimeout` propriété permet de contrôler le moment où les connexions inutilisées sont fermées. Cela réduira le nombre de connexions inutilisées. Par défaut, les connexions inactives restent ouvertes indéfiniment. Cette valeur doit être supérieure ou égale à 10 minutes. Les valeurs recommandées sont comprises entre 20 minutes et 24 heures.  La propriété `PortReuseMode` permet au kit SDK d’utiliser un petit pool de ports éphémères pour différents points de terminaison de destination Azure Cosmos DB.    |
|<input type="checkbox"/> |  Utiliser Async/Await     |  Évitez les appels bloquants `Task.Result`, `Task.Wait` et `Task.GetAwaiter().GetResult()`. L’ensemble de la pile des appels est asynchrone afin de tirer parti des modèles [async/await](/dotnet/csharp/programming-guide/concepts/async/). De nombreux appels bloquants synchrones conduisent à une [défaillance du pool de conversation](/archive/blogs/vancem/diagnosing-net-core-threadpool-starvation-with-perfview-why-my-service-is-not-saturating-all-cores-or-seems-to-stall) et à des temps de réponse qui se dégradent. |
|<input type="checkbox"/>  |   Délais d’expiration de bout en bout | Pour atteindre des délais d’expiration de bout en bout, vous devez utiliser les paramètres `RequestTimeout` et `CancellationToken` . pour plus d’informations sur les délais d’expiration avec Cosmos DB [visitez](troubleshoot-dot-net-sdk-request-timeout.md) |
|<input type="checkbox"/>  |   Logique de nouvelle tentative      |   Une erreur temporaire est une erreur qui a une cause sous-jacente qui se résout rapidement seule. Les applications qui se connectent à votre base de données doivent être conçues de sorte à s’attendre à de telles erreurs temporaires. Pour les gérer, implémentez une logique de nouvelle tentative dans leur code au lieu de les exposer aux utilisateurs comme des erreurs d’application. Le kit de développement logiciel (SDK) intègre une logique permettant de gérer ces échecs temporaires sur des demandes renouvelables telles que des opérations de lecture ou d’interrogation. Le kit de développement logiciel (SDK) ne réessaiera pas les écritures en cas d’échec temporaire, car les écritures ne sont pas idempotent. Le kit de développement logiciel (SDK) permet aux utilisateurs de configurer une logique de nouvelle tentative pour les limitations. Pour plus d’informations sur les erreurs à retenter sur [visitez](troubleshoot-dot-net-sdk.md#retry-logics) |
|<input type="checkbox"/>  |     Mise en cache des noms de base de données/collection    |    Récupérez les noms de vos bases de données et de vos conteneurs à partir de la configuration ou mettez-les en cache au démarrage. Les appels tels que `ReadDatabaseAsync` ou `ReadDocumentCollectionAsync` et `CreateDatabaseQuery` ou `CreateDocumentCollectionQuery` peuvent entraîner des appels de métadonnées au service, qui consomment à partir de la limite de l’unité réservée du système. `CreateIfNotExist` doit également être utilisé une seule fois pour configurer la base de données. De manière générale, ces opérations ne doivent pas être effectuées fréquemment.       |
|<input type="checkbox"/> |     Prise en charge en bloc      |     Dans les scénarios où vous n’avez pas besoin d’optimiser la latence, nous vous recommandons d’activer la [Prise en charge en bloc](https://devblogs.microsoft.com/cosmosdb/introducing-bulk-support-in-the-net-sdk/) pour vider de gros volumes de données.    |
| <input type="checkbox"/>  |     Requêtes parallèles     |    Le kit de développement logiciel (SDK) Cosmos DB prend en charge l' [exécution de requêtes en parallèle](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage) pour améliorer la latence et le débit sur vos requêtes.  Nous vous recommandons de définir la `MaxConcurrency` propriété dans le `QueryRequestsOptions` au nombre de partitions que vous avez. Si vous n’avez pas conscience du nombre de partitions, commencez par utiliser `int.MaxValue`, ce qui vous donnera la meilleure latence. Réduisez ensuite le nombre jusqu’à ce qu’il corresponde aux restrictions de ressources de l’environnement afin d’éviter les problèmes d’UC élevés. En outre, définissez le `MaxBufferedItemCount` sur le nombre attendu de résultats retournés pour limiter le nombre de résultats pré-récupérés. |
| <input type="checkbox"/> |     Tests de performances - Interruptions      |    Lorsque vous effectuez des tests sur votre application, vous devez implémenter des passages à [`RetryAfter`](performance-tips-dotnet-sdk-v3-sql.md#sdk-usage) intervalles. Le respect de l’interruption contribue à garantir un temps d’attente minimal entre les différentes tentatives.   |
|  <input type="checkbox"/>   |   Indexation     |   La stratégie d’indexation d’Azure Cosmos DB vous permet également de spécifier les chemins de document à inclure ou exclure lors de l’indexation en utilisant les chemins d’accès d’indexation (IndexingPolicy.IncludedPaths et IndexingPolicy.ExcludedPaths).  Veillez à exclure les chemins inutilisés de l’indexation pour accélérer les écritures.  Pour obtenir un exemple sur la façon de créer des index à l’aide du kit de développement SDK, [visitez](performance-tips-dotnet-sdk-v3-sql.md#indexing-policy)   |
|  <input type="checkbox"/>   |    Taille du document  |    Les frais de requête d’une opération donnée sont directement liés à la taille du document. Nous vous recommandons de réduire la taille de vos documents, car les opérations sur les documents volumineux coûtent plus que les opérations sur des documents plus petits.      |
| <input type="checkbox"/>   |     Augmenter le nombre de threads/tâches    |    Étant donné que les appels à Azure Cosmos DB sont effectués sur le réseau, vous devrez peut-être modifier le degré de concurrence de vos requêtes, afin que l’application cliente attende un temps minimal entre les requêtes. Par exemple, si vous utilisez la [Bibliothèque parallèle de tâches .NET](/dotnet/standard/parallel-programming/task-parallel-library-tpl), créez dans l’ordre des centaines de tâches de lecture ou d’écriture dans Azure Cosmos DB.     |
|  <input type="checkbox"/> |    Activation des métriques de requête     |  Pour une journalisation supplémentaire de vos exécutions de requêtes principales, vous pouvez activer les métriques de requête SQL à l’aide de notre kit de développement logiciel (SDK) .NET. Pour obtenir des instructions sur la façon de collecter les métriques de requête SQL, [visitez](profile-sql-api-query.md)    |
|  <input type="checkbox"/>    | Journalisation SDK   | Utilisez la journalisation du SDK pour capturer des informations de diagnostic supplémentaires et résoudre les problèmes de latence.  Consignez la [chaîne de diagnostics](/dotnet/api/microsoft.azure.documents.client.resourceresponsebase.requestdiagnosticsstring?view=azure-dotnet&preserve-view=true) dans le kit de développement logiciel (SDK) v2 ou [`Diagnostics`](/dotnet/api/microsoft.azure.cosmos.responsemessage.diagnostics?view=azure-dotnet&preserve-view=true) dans le SDK V3 pour obtenir des informations de diagnostic Cosmos plus détaillées pour la requête en cours au service. À titre d’exemple d’utilisation, capturez les diagnostics sur une exception et sur les opérations terminées si le `Diagnostics.ElapsedTime` est supérieur à une valeur de seuil désignée (par exemple, si vous avez un contrat SLA de 10 secondes, puis capturez les diagnostics lorsque `ElapsedTime` > 10 secondes). Il est recommandé de n’utiliser ces diagnostics que lors des tests de performances.     |

## <a name="best-practices-when-using-gateway-mode"></a>Meilleures pratiques lors de l’utilisation du mode Passerelle
Augmentez `System.Net MaxConnections` par hôte lorsque vous utilisez le mode Passerelle. Les requêtes d’Azure Cosmos DB sont effectuées via le protocole HTTPS/REST lorsque vous utilisez le mode passerelle. Elles sont soumises à la limite de connexion par défaut par nom d’hôte ou adresse IP. Vous devrez peut-être définir `MaxConnections` sur une valeur plus élevée (de 100 à 1 000) afin que la bibliothèque cliente puisse utiliser plusieurs connexions simultanées à Azure Cosmos DB. Dans le kit de développement logiciel (SDK) .NET 1.8.0 et versions ultérieures, la valeur par défaut de `ServicePointManager.DefaultConnectionLimit` est 50. Pour modifier cette valeur, vous pouvez définir `Documents.Client.ConnectionPolicy.MaxConnectionLimit` sur une valeur supérieure.

## <a name="best-practices-for-write-heavy-workloads"></a>Meilleures pratiques pour les charges de travail lourdes en écriture
Pour les charges de travail qui ont des charges utiles de création intensives, attribuez à l’option de requête `EnableContentResponseOnWrite` la valeur `false`. Le service ne renvoie plus la ressource créée ou mise à jour au kit de développement logiciel (SDK). Normalement, comme l’application détient l’objet en cours de création, le service n’a pas besoin de le retourner. Les valeurs d’en-tête sont toujours accessibles, comme des frais de requête. La désactivation de la réponse de contenu peut améliorer les performances, car le kit SDK n’a plus besoin d’allouer de la mémoire ni de sérialiser le corps de la réponse. Cela réduit également l’utilisation de la bande passante réseau pour améliorer encore les performances.

## <a name="next-steps"></a>Étapes suivantes
Pour obtenir un exemple d’application permettant d’évaluer Azure Cosmos DB lors de scénarios hautes performances sur quelques ordinateurs clients, consultez [Test des performances et de la mise à l’échelle avec Azure Cosmos DB](performance-testing.md).

Pour en savoir plus sur la conception de votre application pour une mise à l’échelle et de hautes performances, consultez [Partitionnement, clés de partition et mise à l’échelle dans Cosmos DB](../partitioning-overview.md).

Vous tentez d’effectuer une planification de la capacité pour une migration vers Azure Cosmos DB ? Vous pouvez utiliser les informations sur votre cluster de bases de données existant pour la planification de la capacité.
* Si vous ne connaissez que le nombre de vCore et de serveurs présents dans votre cluster de bases de données existant, lisez l’article sur l’[estimation des unités de requête à l’aide de vCore ou de processeurs virtuels](../convert-vcore-to-request-unit.md) 
* Si vous connaissez les taux de requêtes typiques de votre charge de travail de base de données actuelle, lisez la section concernant l’[estimation des unités de requête à l’aide du planificateur de capacité Azure Cosmos DB](estimate-ru-with-capacity-planner.md)
